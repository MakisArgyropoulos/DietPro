import streamlit as st
import pandas as pd
import plotly.express as px
import datetime
import os
import io

# --- Î”ÎµÎ´Î¿Î¼Î­Î½Î± ---
data = {
    "ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±": [
        "Î£Î½Î±Îº","Î£Î½Î±Îº","Î£Î½Î±Îº","Î£Î½Î±Îº","Î£Î½Î±Îº","Î£Î½Î±Îº","Î£Î½Î±Îº","Î£Î½Î±Îº","Î£Î½Î±Îº",
        "Î ÏÏ‰Î¹Î½ÏŒ","Î ÏÏ‰Î¹Î½ÏŒ","Î ÏÏ‰Î¹Î½ÏŒ","Î ÏÏ‰Î¹Î½ÏŒ","Î ÏÏ‰Î¹Î½ÏŒ","Î ÏÏ‰Î¹Î½ÏŒ",
        "ÎšÏ…ÏÎ¯Ï‰Ï‚ Î“ÎµÏÎ¼Î±","ÎšÏ…ÏÎ¯Ï‰Ï‚ Î“ÎµÏÎ¼Î±","ÎšÏ…ÏÎ¯Ï‰Ï‚ Î“ÎµÏÎ¼Î±","ÎšÏ…ÏÎ¯Ï‰Ï‚ Î“ÎµÏÎ¼Î±","ÎšÏ…ÏÎ¯Ï‰Ï‚ Î“ÎµÏÎ¼Î±",
        "ÎšÏ…ÏÎ¯Ï‰Ï‚ Î“ÎµÏÎ¼Î±","ÎšÏ…ÏÎ¯Ï‰Ï‚ Î“ÎµÏÎ¼Î±","ÎšÏ…ÏÎ¯Ï‰Ï‚ Î“ÎµÏÎ¼Î±","ÎšÏ…ÏÎ¯Ï‰Ï‚ Î“ÎµÏÎ¼Î±","ÎšÏ…ÏÎ¯Ï‰Ï‚ Î“ÎµÏÎ¼Î±",
        "Î”ÎµÏÏ„ÎµÏÎ¿ Î“ÎµÏÎ¼Î±","Î”ÎµÏÏ„ÎµÏÎ¿ Î“ÎµÏÎ¼Î±","Î”ÎµÏÏ„ÎµÏÎ¿ Î“ÎµÏÎ¼Î±","Î”ÎµÏÏ„ÎµÏÎ¿ Î“ÎµÏÎ¼Î±","Î”ÎµÏÏ„ÎµÏÎ¿ Î“ÎµÏÎ¼Î±",
        "Î”ÎµÏÏ„ÎµÏÎ¿ Î“ÎµÏÎ¼Î±","Î”ÎµÏÏ„ÎµÏÎ¿ Î“ÎµÏÎ¼Î±","Î”ÎµÏÏ„ÎµÏÎ¿ Î“ÎµÏÎ¼Î±","Î”ÎµÏÏ„ÎµÏÎ¿ Î“ÎµÏÎ¼Î±"
    ],
    "Î•Ï€Î¹Î»Î¿Î³Î®": [
        "Î¤Î¯Ï€Î¿Ï„Î±","1-2 Î¦ÏÎ¿ÏÏ„Î±","1 Î¦ÏÎ¿ÏÏ„Î¿ Î¼Îµ 1 Ï‡Î¿ÏÏ†Ï„Î± Î±Î¼ÏÎ³Î´Î±Î»Î±","2-3 Î´Î±Î¼Î¬ÏƒÎºÎ·Î½Î± ÎºÎ±Î¹ 12 Î±Î¼ÏÎ³Î´Î±Î»Î±","Î“Î¹Î±Î¿ÏÏÏ„Î¹ 2% Î¼Îµ 1 Îº.Î³. Î¼Î­Î»Î¹",
        "2 Ï†ÏÏ…Î³Î±Î½Î¹Î­Ï‚ Î¼Îµ 2 Ï†Î­Ï„ÎµÏ‚ Ï„Ï…ÏÎ¯","2 Ï†ÏÏ…Î³Î±Î½Î¹Î­Ï‚ Î¼Îµ 100 Î³Ï. cottage cheese","1 Ï€Î¿Ï„Î®ÏÎ¹ ÎºÎµÏ†Î¯Ï (ÎºÎ±Î¹ 1 Ï†ÏÎ¿ÏÏ„Î¿)","1 Î¼Ï€Î¬Î»Î± Ï€Î±Î³Ï‰Ï„ÏŒ",
        "Î¤Î¯Ï€Î¿Ï„Î±","ÎœÎ¹ÎºÏÎ® Î±ÏÎ±Î²Î¹ÎºÎ® Î¼Îµ 2 Ï†Î­Ï„ÎµÏ‚ Ï„Ï…ÏÎ¯ light","ÎœÎ¹ÎºÏÎ® Î±ÏÎ±Î²Î¹ÎºÎ® Î¼Îµ 1 Î±Ï…Î³ÏŒ ÎºÎ±Î¹ 1 Ï†Î­Ï„Î± Ï„Ï…ÏÎ¯","Î¨Ï‰Î¼Î¯ Î¼Îµ 2 Îº.Ïƒ. cottage cheese, 1 Î±Ï…Î³ÏŒ ÎºÎ±Î¹ 1/4 Î±Î²Î¿ÎºÎ¬Î½Ï„Î¿",
        "ÎšÎ¿Ï…Î»Î¿ÏÏÎ¹ Î˜ÎµÏƒÏƒÎ±Î»Î¿Î½Î¯ÎºÎ·Ï‚ Î¼Îµ Î³Î¹Î±Î¿ÏÏÏ„Î¹ 2%","Î“Î¹Î±Î¿ÏÏÏ„Î¹ 2% Î¼Îµ 2 Îº.Ïƒ. Î²ÏÏÎ¼Î·, 1 Îº.Î³. Î¼Î­Î»Î¹, 1 Ï†ÏÎ¿ÏÏ„Î¿ ÎºÎ±Î¹ 2-3 ÎºÎ±ÏÏÎ´Î¹Î±",
        "Î¤Î¯Ï€Î¿Ï„Î±","ÎŒÏƒÏ€ÏÎ¹Î± (1,5 Ï†Î»Î¹Ï„Î¶.), 50 Î³Ï. Î±Î½Î¸ÏŒÏ„Ï…ÏÎ¿, 2 Ï€Î±Î¾Î¹Î¼Î±Î´Î¬ÎºÎ¹Î±","Î¨Î¬ÏÎ¹ (180 Î³Ï.) Î¼Îµ 1 Ï€Î±Ï„Î¬Ï„Î± Î²ÏÎ±ÏƒÏ„Î®","ÎœÏ€Î¹Ï†Ï„Î­ÎºÎ¹Î± (200 Î³Ï.) Î® ÎœÏ€Î¹Ï†Ï„Î­ÎºÎ¹Î± ÎºÎ¿Ï„ÏŒÏ€Î¿Ï…Î»Î¿ (250 Î³Ï.)",
        "ÎœÎ¿ÏƒÏ‡Î¬ÏÎ¹ (120 Î³Ï.) Î¼Îµ ÏÏÎ¶Î¹ (1 Ï†Î»Î¹Ï„Î¶.)","Î‘ÏÎ±ÎºÎ¬Ï‚/Î¦Î±ÏƒÎ¿Î»Î¬ÎºÎ¹Î± (1,5 Ï†Î»Î¹Ï„Î¶.) Î¼Îµ Ï„Ï…ÏÎ¯ (60 Î³Ï.)","ÎšÎ¿Ï„ÏŒÏ€Î¿Ï…Î»Î¿ (150 Î³Ï.) Î¼Îµ Ï€Î±Ï„Î¬Ï„ÎµÏ‚ (1 Ï†Î»Î¹Ï„Î¶.)",
        "ÎœÎ±ÎºÎ±ÏÏŒÎ½Î¹Î± (1,5 Ï†Î»Î¹Ï„Î¶.) Î¼Îµ ÎºÎ¹Î¼Î¬ (6 Îº.Ïƒ.) ÎºÎ±Î¹ Ï„Ï…ÏÎ¯ (1 Îº.Ïƒ.)","Î£Î±Î»Î¬Ï„Î± Î¼Îµ 2 Î±Ï…Î³Î¬, 50 Î³Ï. cottage cheese ÎºÎ±Î¹ 2 Ï€Î±Ï„Î¬Ï„ÎµÏ‚ Î²ÏÎ±ÏƒÏ„Î­Ï‚","ÎŸÎ¼ÎµÎ»Î­Ï„Î± Î¼Îµ 2 Î±Ï…Î³Î¬, 30 Î³Ï. Ï„Ï…ÏÎ¯ Î»Î±Ï‡Î±Î½Î¹ÎºÎ¬ ÎºÎ±Î¹ 2 Îº.Î³. ÎµÎ»Î±Î¹ÏŒÎ»Î±Î´Î¿",
        "Î¤Î¯Ï€Î¿Ï„Î±","Î‘ÏÎ±Î²Î¹ÎºÎ® Î¼Îµ 120 Î³Ï. ÎºÎ¿Ï„ÏŒÏ€Î¿Ï…Î»Î¿, Î»Î±Ï‡Î±Î½Î¹ÎºÎ¬ ÎºÎ±Î¹ 1 Îº.Ïƒ. Î³Î¹Î±Î¿ÏÏÏ„Î¹","Î§Ï‰ÏÎ¹Î¬Ï„Î¹ÎºÎ·/ÎÏ„Î¬ÎºÎ¿Ï‚ Î¼Îµ 100 Î³Ï. ÎºÎ±Ï„Î¯ÎºÎ¹, 2 Ï€Î±Î¾Î¹Î¼Î¬Î´Î¬ÎºÎ¹Î± ÎºÎ±Î¹ 2 Îº.Î³. ÎµÎ»Î±Î¹ÏŒÎ»Î±Î´Î¿","ÎšÎ¿Ï„Î¿Î¼Ï€Î¿Ï…ÎºÎ¹Î­Ï‚ (150Î³Ï.) Î¼Îµ ÏƒÎ±Î»Î¬Ï„Î± ÎºÎ±Î¹ 2 Îº.Î³. ÎµÎ»Î±Î¹ÏŒÎ»Î±Î´Î¿",
        "ÎœÏ€Î¹Ï†Ï„Î­ÎºÎ¹Î± (120 Î³Ï.) Î® ÎœÏ€Î¹Ï†Ï„Î­ÎºÎ¹Î± ÎºÎ¿Ï„ÏŒÏ€Î¿Ï…Î»Î¿ (150 Î³Ï.) Î¼Îµ ÏƒÎ±Î»Î¬Ï„Î± ÎºÎ±Î¹ 2 Îº.Î³. ÎµÎ»Î±Î¹ÏŒÎ»Î±Î´Î¿","Î£Î±Î»Î¬Ï„Î± Î¼Îµ 120 Î³Ï. ÎºÎ¿Ï„ÏŒÏ€Î¿Ï…Î»Î¿, 2 Îº.Ïƒ. ÎºÎ±Î»Î±Î¼Ï€ÏŒÎºÎ¹ ÎºÎ±Î¹ 2 Îº.Î³. ÎµÎ»Î±Î¹ÏŒÎ»Î±Î´Î¿",
        "Î£Î±Î»Î¬Ï„Î± Î¼Îµ 100 Î³Ï. Ï„ÏŒÎ½Î¿, 2 Îº.Ïƒ. ÎºÏÎ¿Ï…Ï„ÏŒÎ½ ÎºÎ±Î¹ 1/4 Î±Î²Î¿ÎºÎ¬Î½Ï„Î¿","ÎŸÎ¼ÎµÎ»Î­Ï„Î± Î¼Îµ 2 Î±Ï…Î³Î¬, 2 Î±ÏƒÏ€ÏÎ¬Î´Î¹Î±, 30 Î³Ï. Ï„Ï…ÏÎ¯, Î»Î±Ï‡Î±Î½Î¹ÎºÎ¬ 2 Îº.Î³. ÎµÎ»Î±Î¹ÏŒÎ»Î±Î´Î¿ ÎºÎ±Î¹ 1 Ï†Î­Ï„Î± ÏˆÏ‰Î¼Î¯","2 ÎºÎ±Î»Î±Î¼Î¬ÎºÎ¹Î± ÎºÎ¿Ï„ÏŒÏ€Î¿Ï…Î»Î¿ Î¼Îµ 1 Ï€Î¹Ï„Î¬ÎºÎ¹"
    ],
    "Î˜ÎµÏÎ¼Î¯Î´ÎµÏ‚ (kcal)": [0,80,200,220,140,220,190,150,180,0,220,280,300,350,320,0,500,480,550,520,450,500,650,500,450,0,450,500,480,500,480,450,550,500],
    "Î ÏÏ‰Ï„ÎµÎÎ½Î· (g)": [0,1,6,5,8,12,10,8,3,0,12,15,16,12,14,0,22,35,40,32,20,35,28,20,18,0,28,20,26,25,28,25,26,30],
    "Î¥Î´Î±Ï„Î¬Î½Î¸ÏÎ±ÎºÎµÏ‚ (g)": [0,20,15,20,15,20,18,12,22,0,28,26,28,45,40,0,50,35,20,40,35,35,70,35,12,0,40,35,20,20,25,18,28,30],
    "Î›Î¯Ï€Î¿Ï‚ (g)": [0,0,12,10,4,7,5,5,7,0,5,8,10,8,8,0,15,10,20,15,14,12,20,10,28,0,12,18,15,18,15,20,20,15],
    "Î¦Ï…Ï„Î¹ÎºÎ­Ï‚ Î¯Î½ÎµÏ‚ (g)": [0,3,4,5,0,2,1,0,0,0,2,2,3,4,5,0,9,2,1,3,8,3,6,5,4,0,4,6,3,3,4,5,6,3]
}

df = pd.DataFrame(data)


st.set_page_config(page_title="DietPro", page_icon="ğŸ¥—", layout="centered")
st.title("DietPro â€“ Î—Î¼ÎµÏÎ®ÏƒÎ¹Î¿Ï‚ Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Î˜ÎµÏÎ¼Î¯Î´Ï‰Î½ & ÎœÎ±ÎºÏÎ¿Î¸ÏÎµÏ€Ï„Î¹ÎºÏÎ½")
st.write("Î•Ï€Î¯Î»ÎµÎ¾Îµ 3 ÏƒÎ½Î±Îº ÎºÎ±Î¹ 3 Î³ÎµÏÎ¼Î±Ï„Î±. ÎœÏ€Î¿ÏÎµÎ¯Ï‚ Î½Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏÏƒÎµÎ¹Ï‚ Ï„Î·Î½ Î·Î¼Î­ÏÎ± ÏƒÎ¿Ï… ÎºÎ±Î¹ Î½Î± ÎºÎ±Ï„ÎµÎ²Î¬ÏƒÎµÎ¹Ï‚ Ï„Î¿ Î¹ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ.")

# --- Î•Ï€Î¹Î»Î¿Î³Î­Ï‚ Î±Î½Î¬ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î± ---
breakfast_options = df[df["ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±"] == "Î ÏÏ‰Î¹Î½ÏŒ"]["Î•Ï€Î¹Î»Î¿Î³Î®"].tolist()
snack_options = df[df["ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±"] == "Î£Î½Î±Îº"]["Î•Ï€Î¹Î»Î¿Î³Î®"].tolist()
main_meal_options = df[df["ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±"] == "ÎšÏ…ÏÎ¯Ï‰Ï‚ Î“ÎµÏÎ¼Î±"]["Î•Ï€Î¹Î»Î¿Î³Î®"].tolist()
second_meal_options = df[df["ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±"] == "Î”ÎµÏÏ„ÎµÏÎ¿ Î“ÎµÏÎ¼Î±"]["Î•Ï€Î¹Î»Î¿Î³Î®"].tolist()

# --- Î•Ï€Î¹Î»Î¿Î³Î­Ï‚ Î¼Îµ ÏƒÎµÎ¹ÏÎ¬ ---
breakfast = st.selectbox("Î ÏÏ‰Î¹Î½ÏŒ", breakfast_options, key="breakfast")
snack1 = st.selectbox("Î£Î½Î±Îº 1", snack_options, key="snack1")
main_meal = st.selectbox("ÎšÏ…ÏÎ¯Ï‰Ï‚ Î“ÎµÏÎ¼Î±", main_meal_options, key="main_meal")
snack2 = st.selectbox("Î£Î½Î±Îº 2", snack_options, key="snack2")
second_meal = st.selectbox("Î”ÎµÏÏ„ÎµÏÎ¿ Î“ÎµÏÎ¼Î±", second_meal_options, key="second_meal")
snack3 = st.selectbox("Î£Î½Î±Îº 3", snack_options, key="snack3")

# --- Î£Ï„Î±Î¸ÎµÏÎ® ÏƒÎµÎ¹ÏÎ¬ ÎµÏ€Î¹Î»Î¿Î³ÏÎ½ ---
choices = {
    "Î ÏÏ‰Î¹Î½ÏŒ": breakfast,
    "Î£Î½Î±Îº 1": snack1,
    "ÎšÏ…ÏÎ¯Ï‰Ï‚ Î“ÎµÏÎ¼Î±": main_meal,
    "Î£Î½Î±Îº 2": snack2,
    "Î”ÎµÏÏ„ÎµÏÎ¿ Î“ÎµÏÎ¼Î±": second_meal,
    "Î£Î½Î±Îº 3": snack3
}

rows = []
total_cal = total_prot = total_carb = total_fat = total_fiber = 0

for category, item in choices.items():
    row = df[df["Î•Ï€Î¹Î»Î¿Î³Î®"] == item]
    if not row.empty:
        cal = row["Î˜ÎµÏÎ¼Î¯Î´ÎµÏ‚ (kcal)"].values[0]
        prot = row["Î ÏÏ‰Ï„ÎµÎÎ½Î· (g)"].values[0]
        carb = row["Î¥Î´Î±Ï„Î¬Î½Î¸ÏÎ±ÎºÎµÏ‚ (g)"].values[0]
        fat = row["Î›Î¯Ï€Î¿Ï‚ (g)"].values[0]
        fiber = row["Î¦Ï…Ï„Î¹ÎºÎ­Ï‚ Î¯Î½ÎµÏ‚ (g)"].values[0]
    else:
        cal = prot = carb = fat = fiber = 0

    rows.append({
        "ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±": category,
        "Î•Ï€Î¹Î»Î¿Î³Î®": item,
        "Î˜ÎµÏÎ¼Î¯Î´ÎµÏ‚ (kcal)": cal,
        "Î ÏÏ‰Ï„ÎµÎÎ½Î· (g)": prot,
        "Î¥Î´Î±Ï„Î¬Î½Î¸ÏÎ±ÎºÎµÏ‚ (g)": carb,
        "Î›Î¯Ï€Î¿Ï‚ (g)": fat,
        "Î¦Ï…Ï„Î¹ÎºÎ­Ï‚ Î¯Î½ÎµÏ‚ (g)": fiber
    })

    total_cal += cal
    total_prot += prot
    total_carb += carb
    total_fat += fat
    total_fiber += fiber

# DataFrame Î³Î¹Î± ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎ·
selected_df = pd.DataFrame(rows)





# --- Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿Î¯ ---
total_cal = selected_df["Î˜ÎµÏÎ¼Î¯Î´ÎµÏ‚ (kcal)"].sum()
total_prot = selected_df["Î ÏÏ‰Ï„ÎµÎÎ½Î· (g)"].sum()
total_carb = selected_df["Î¥Î´Î±Ï„Î¬Î½Î¸ÏÎ±ÎºÎµÏ‚ (g)"].sum()
total_fat = selected_df["Î›Î¯Ï€Î¿Ï‚ (g)"].sum()
total_fiber = selected_df["Î¦Ï…Ï„Î¹ÎºÎ­Ï‚ Î¯Î½ÎµÏ‚ (g)"].sum()

st.subheader("Î£ÏÎ½Î¿Î»Î¿:")
st.write(f"**Î˜ÎµÏÎ¼Î¯Î´ÎµÏ‚:** {total_cal} kcal")
st.write(f"**Î ÏÏ‰Ï„ÎµÎÎ½Î·:** {total_prot} g | **Î¥Î´Î±Ï„Î¬Î½Î¸ÏÎ±ÎºÎµÏ‚:** {total_carb} g | **Î›Î¯Ï€Î¿Ï‚:** {total_fat} g | **Î¦Ï…Ï„Î¹ÎºÎ­Ï‚ Î¯Î½ÎµÏ‚:** {total_fiber} g")

# --- Î£Ï„ÏŒÏ‡Î¿Î¹ ---
prot_target = 150
carb_target = 200
fat_target = 70
fiber_target = 25

# --- Progress Î³Î¹Î± ÎºÎ¬Î¸Îµ Î¼Î±ÎºÏÎ¿Î¸ÏÎµÏ€Ï„Î¹ÎºÏŒ ---
st.subheader("ÎšÎ¬Î»Ï…ÏˆÎ· Î£Ï„ÏŒÏ‡Ï‰Î½ ÎœÎ±ÎºÏÎ¿Î¸ÏÎµÏ€Ï„Î¹ÎºÏÎ½:")
st.write(f"Î ÏÏ‰Ï„ÎµÎÎ½Î·: {total_prot}g / {prot_target}g")
st.progress(min(total_prot / prot_target, 1.0))

st.write(f"Î¥Î´Î±Ï„Î¬Î½Î¸ÏÎ±ÎºÎµÏ‚: {total_carb}g / {carb_target}g")
st.progress(min(total_carb / carb_target, 1.0))

st.write(f"Î›Î¯Ï€Î¿Ï‚: {total_fat}g / {fat_target}g")
st.progress(min(total_fat / fat_target, 1.0))

st.write(f"Î¦Ï…Ï„Î¹ÎºÎ­Ï‚ Î¯Î½ÎµÏ‚: {total_fiber}g / {fiber_target}g")
st.progress(min(total_fiber / fiber_target, 1.0))




# --- Î”Î¹Î¬Î³ÏÎ±Î¼Î¼Î± Î Î¯Ï„Î±Ï‚ ---
if total_cal > 0:
    macros = {"Î ÏÏ‰Ï„ÎµÎÎ½Î·": total_prot, "Î¥Î´Î±Ï„Î¬Î½Î¸ÏÎ±ÎºÎµÏ‚": total_carb, "Î›Î¯Ï€Î¿Ï‚": total_fat}
    fig = px.pie(values=macros.values(), names=macros.keys(), title="ÎšÎ±Ï„Î±Î½Î¿Î¼Î® ÎœÎ±ÎºÏÎ¿Î¸ÏÎµÏ€Ï„Î¹ÎºÏÎ½")
    st.plotly_chart(fig)

st.write("Î‘Î½Î±Î»Ï…Ï„Î¹ÎºÎ¬:")
st.dataframe(selected_df)
# --- Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Ï€Î¿ÏƒÎ¿ÏƒÏ„ÏÎ½ ÎºÎ¬Î»Ï…ÏˆÎ·Ï‚ ---
prot_target = 150
carb_target = 200
fat_target = 70
fiber_target = 25

prot_pct = round((total_prot / prot_target) * 100, 1)
carb_pct = round((total_carb / carb_target) * 100, 1)
fat_pct = round((total_fat / fat_target) * 100, 1)
fiber_pct = round((total_fiber / fiber_target) * 100, 1)

# --- Î•Ï€Î¹Î»Î¿Î³Î® Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±Ï‚ ---
selected_date = st.date_input("Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± ÎºÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ·Ï‚", value=datetime.date.today())

# --- Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Î—Î¼Î­ÏÎ±Ï‚ ---
history_file = "history.csv"
if st.button("Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Î—Î¼Î­ÏÎ±Ï‚"):
    # Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î½Î­Î±Ï‚ ÎµÎ³Î³ÏÎ±Ï†Î®Ï‚
    new_entry = {
        "Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±": str(selected_date),
        "Î ÏÏ‰Î¹Î½ÏŒ": breakfast,
        "Î£Î½Î±Îº1": snack1,
        "ÎšÏ…ÏÎ¯Ï‰Ï‚ Î“ÎµÏÎ¼Î±": main_meal,
        "Î£Î½Î±Îº2": snack2,
        "Î”ÎµÏÏ„ÎµÏÎ¿ Î“ÎµÏÎ¼Î±": second_meal,
        "Î£Î½Î±Îº3": snack3,
        "Î˜ÎµÏÎ¼Î¯Î´ÎµÏ‚": total_cal,
        "Î ÏÏ‰Ï„ÎµÎÎ½Î·": total_prot,
        "Î ÏÏ‰Ï„ÎµÎÎ½Î·_%": prot_pct,
        "Î¥Î´Î±Ï„Î¬Î½Î¸ÏÎ±ÎºÎµÏ‚": total_carb,
        "Î¥Î´Î±Ï„Î¬Î½Î¸ÏÎ±ÎºÎµÏ‚_%": carb_pct,
        "Î›Î¯Ï€Î¿Ï‚": total_fat,
        "Î›Î¯Ï€Î¿Ï‚_%": fat_pct,
        "Î¦Ï…Ï„Î¹ÎºÎ­Ï‚ Î¯Î½ÎµÏ‚": total_fiber,
        "Î¦Ï…Ï„Î¹ÎºÎ­Ï‚ Î¯Î½ÎµÏ‚_%": fiber_pct
    }

    # Î¦ÏŒÏÏ„Ï‰ÏƒÎµ / ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎµ Ï„Î¿ Î¹ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ
    if os.path.exists(history_file):
        history_df = pd.read_csv(history_file)
        # Î‘Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î· ÎµÎ³Î³ÏÎ±Ï†Î® Î³Î¹Î± Ï„Î·Î½ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± â†’ ÏƒÎ²Î®ÏƒÎµ Ï„Î·Î½
        history_df = history_df[history_df["Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±"] != str(selected_date)]
        # Î ÏÏŒÏƒÎ¸ÎµÏƒÎµ Ï„Î· Î½Î­Î±
        history_df = pd.concat([history_df, pd.DataFrame([new_entry])], ignore_index=True)
    else:
        history_df = pd.DataFrame([new_entry])

    # Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·
    history_df.to_csv(history_file, index=False)
    st.success(f"Î— ÎºÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ· Î³Î¹Î± {selected_date} Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ!")




# --- Î ÏÎ¿Î²Î¿Î»Î® Î™ÏƒÏ„Î¿ÏÎ¹ÎºÎ¿Ï & Î›Î®ÏˆÎ· ---
if os.path.exists(history_file):
    st.subheader("Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Î—Î¼ÎµÏÏÎ½")
    history_df = pd.read_csv(history_file)

    # Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· Ï€Î¯Î½Î±ÎºÎ± Î¼Îµ ÎºÎ¿Ï…Î¼Ï€Î¯ Î´Î¹Î±Î³ÏÎ±Ï†Î®Ï‚
    for i, row in history_df.iterrows():
        col1, col2 = st.columns([6,1])
        with col1:
            st.write(f"{row['Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±']} | Î˜ÎµÏÎ¼Î¯Î´ÎµÏ‚: {row['Î˜ÎµÏÎ¼Î¯Î´ÎµÏ‚']} kcal | Î ÏÏ‰Ï„ÎµÎÎ½Î·: {row['Î ÏÏ‰Ï„ÎµÎÎ½Î·']}g")
        with col2:
            if st.button("Î”Î¹Î±Î³ÏÎ±Ï†Î®", key=f"del_{i}"):
                history_df = history_df.drop(i)
                history_df.to_csv(history_file, index=False)
                st.success(f"Î— ÎºÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ· Ï„Î·Ï‚ {row['Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±']} Î´Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎµ.")
                st.rerun()

    # ÎšÎ±Ï„Î­Î²Î±ÏƒÎ¼Î± Excel
    output = io.BytesIO()
    with pd.ExcelWriter(output, engine='xlsxwriter') as writer:
        history_df.to_excel(writer, index=False, sheet_name='Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ')
    st.download_button(
        label="Î›Î®ÏˆÎ· Î™ÏƒÏ„Î¿ÏÎ¹ÎºÎ¿Ï ÏƒÎµ Excel",
        data=output.getvalue(),
        file_name="history.xlsx",
        mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
    )

